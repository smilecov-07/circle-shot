# Создание оружия

Процесс создания оружие сильно зависит от того, создаёте ли Вы оружие нового типа или уже существующего. Обратитесь к нужной секции документа, когда сделаете выбор. Не забудьте прочитать общие инструкцию и моменты.

## Общая инструкция

**Заметка**: это инструкция по созданию *оружия*. Если Вы хотите создать *класс оружия*, обратитесь к [соответствующей секции документа](#создание-класса-оружия).

1. Создайте папку в `game/weapons/<класс оружия>` с именем Вашего оружия в *snake_case*, где *класс оружия* - название класса создаваемого оружия (или `other`, если Вы не относите его ни к какому классу).
2. В этой папке создайте ресурс типа `WeaponData`, назовите именем Вашего оружия (всё ещё в *snake_case*) и заполните в нём информацию:
    - В `Name` введите название Вашего оружия.
    - В `Rarity` укажите редкость оружия. Как определяется редкость см. [`giving_rarity.md`](./giving_rarity.md#оружия).
    - В `ID` укажите идентификатор Вашего оружия (на английском и в *snake_case*). Он должен отражать сущность оружия, но подражать имени не обязан, так что можно вписать какую-нибудь связанную с создаваемым оружием шутку :)
    - Во вкладке `About`:
        - В словаре `Stats` укажите статистики Вашего оружия (урон, боеприпасы и прочее). В дальнейшем при описании оружия ссылайтесь на эти статистики при помощи `{<нужная статистика>}`.
        - В `Damage Text` кратко укажите, какой урон наносит оружие.
            - Для большинства рекомендуется формат "Урон/с: ХХ", однако для оружия, делающего редкие выстрелы (между ними секунда и более), или одноразового оружия (гранаты) можно просто указать "Урон: ХХ".
            - Если же оружие не наносит урон, кратко опишите его действие.
        - В `Ammo Text` укажите количество боеприпасов оружия в формате "<боеприпасов в магазине>/<боеприпасов в запасе>".
            - Если оружие не имеет магазина, то напишите "ХХ штук(и)".
            - Если же количество боеприпасов неограниченно, то так и напишите: "Не ограничено".
        - В `Description` полностью опишите оружие по плану ниже, отделяя пункты друг от друга пустой строкой. Рекомендуется выделять числа с помощью *BBCode*: связанное с уроном - красным (`[color=red]`), с боеприпасами - синим (`[color=blue]`), особенностями - голубым (`[color=deep_sky_blue]`). Максимальная точность дробных чисел - десятые доли.
            - Урон и особенности
            - Боеприпасы и перезарядка
            - Текстовое описание
    - `Scene Path` и `Image Path` будут заполнены позже.
3. Создайте сцену оружия и само оружие. Обратитесь к секциям ниже для большей информации.
4. Полученную сцену с оружием сохраните в папку Вашего оружия с именем в *snake_case*. Укажите её в `*.tres`-файле Вашего оружия (свойство `Scene Path`).
    - Если оружие создаёт объекты на сервере, которые должны быть появляться у всех (например, пули), то укажите их сцены в `Spawnable Scenes Paths` в `*.tres`-файле Вашего оружия.
5. Для оружия необходима его обложка разрешением 256 пикселей по *большей* стороне. Скорей всего, изображение целого оружия у вас осталось с момента рисования. Измените его размер до нужного и сохраните его как `image.png` в папку Вашего оружия.
6. Укажите полученный `image.png` в свойстве `Image Path` `*.tres`-файла Вашего оружия.
7. Откройте `game/core/items_db.tres` и добавьте `*.tres`-файл Вашего оружия в свойство `Weapons <тип оружия>`, где *тип оружия* - *Light* (лёгкое), *Heavy* (тяжёлое), *Support* (поддержка) или *Melee* (ближнее).
8. Готово! Теперь Ваше оружие можно выбрать в игре.
9. Протестируйте его и при необходимости сбалансируйте. Не забудьте отредактировать `Damage Text`, `Ammo Text` и `Description`.

## Общие моменты

- Создавайте объекты в качестве дочерних к узлу `ProjectilesParent` (можно использовать свойство `_projectiles_parent` в скрипте оружия) если нужно, чтобы их появление синхронизировалось между клиентами.
- Главное правило при создании оружия конкретного класса - если непонятно, взгляните на другие оружия этого класса!
- Оптимизируйте рендеринг оружия при помощи `Region` у `Sprite2D` в случае, если в текстуре много прозрачных областей (магазин, затвор, ...). Используйте при этом сетку и шаг в 8 пикселей. Чтобы поставить спрайт в нужную позицию, поменяйте `Offset` по следующей формуле для каждой оси: `(размертекстуры по X|Y) / -2 + (регион X|Y) + (регион W|H) / 2 + (изначальный offset)`.
- Начало координат в сцене оружия - точка, в которой игрок держится за оружие, она же и ось вращения.
- Если оружие не имеет магазина, то в `Ammo Per Load` напишите 0 и используйте только `ammo_in_stock`.
- Помните, что изначальное количество боеприпасов в запасе это `Ammo Total - Ammo Per Load`. Учитывайте это в `Ammo Text`.
- Перед рисованием ознакомьтесь с [`drawing.md`](./drawing.md), а также про ещё несколько моментов:
    - Рекомендуется рисовать оружия по слоям. Это позволяет проще вносить изменения в будущем и сохранять части оружия (затвор, магазин).
    - Насчёт разрешения текстур: если внутри игры оружие должно быть меньше 256 пикселей по большей стороне, то рисуйте текстуру в разрешении 256 по большей стороне, а при экспорте просто уменьшите **на время** размер.
    - После того как закончите рисовать, сохраните файл в формате в куда нибудь в папку `krita`, чтобы не потерять оригинал.
    - И после этого уменьшайте/увеличивайте размеры, скрывайте/показывайте слои как надо, чтобы сохранить нужные текстуры в папку оружия (не забудьте `image.png`!).
- Не забывайте устанавливать `collision_layer` и `collision_mask` у детекторов для атаки (см. [`architecture.md`](../architecture.md#физика) для информации по слоям).

## Создание оружия существующего класса

### Пистолет (класс `Gun`)

1. Унаследуйтесь от `game/weapons/guns/common/gun.tscn` и сохраните новую сцену в папку своего оружия как `имя_оружия_в_snake_case.tscn`.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Нарисуйте оружие (см. Общие моменты).
4. Расположите в сцене спрайты с текстурами оружия. Не рекомендую менять `position`, вместо этого меняйте `offset` у `Sprite2D`. Позицию меняйте только в анимациях.
5. Настройте оружие. Посмотрите, сколько разных свойств у коренного узла! Изучите их всех (обратитесь к документации) и настройте как надо. `Projectile Scene` пока назначать не нужно - это мы сделаем позже.
6. После этого в узле `AnimationPlayer` создайте нужные анимации.
    - `Equip`: анимация экипировки. Не доводите оружие полностью до боевой готовности (см. ниже).
    - `PostEquip`: анимация окончания экипировки. Здесь нужно довести оружие до боевой готовности, то есть отсутствия отклонения от линии прицела. Её длительность **должна** совпадать со свойством `To Aim Time`.
    - `Reload`: анимация перезарядки. Не доводите оружие полностью до боевой готовности (аналогично `Equip`).
    - `PostReload`: анимация окончания перезарядки. Здесь нужно довести оружие до боевой готовности. Её длительность тоже **должна** совпадать со свойством `To Aim Time`.
    - `Shoot`: анимация стрельбы. Длительность желательно должна совпадать с `Shoot Interval`, но это необязательно.
    - `RESET`: анимация сброса. Должна содержать начальное положение оружия и скрывать любые эффекты. Она используется для сброса состояния оружия в любой момент, как игрок пожелает. Автоматически создаётся движком по мере создания дорожек анимации.
7. Переместите `ShootPoint` в точку, откуда должны вылетать снаряды.
8. Создайте снаряд, унаследовавшись от `game/weapon/guns/common/bullet.tscn` (или напрямую от `game/entity/attack/projectile.tscn`), назовите корневой узел как `<имя вашего оружия в PascalCase>Bullet` (или по другому, если это не пуля), отредактируйте урон и скорость и сохраните в папку Вашего оружия. Не забудьте указать эту сцену в `Spawnable Scenes Paths` и в `Projectile Scene`!
9. При необходимости можно расширить скрипт оружия и написать собственную логику, будь то дополнительная кнопка или что-нибудь ещё.

### Бросаемое оружие (класс `Throwable`)

1. Унаследуйтесь от `game/weapons/throwable/common/throwable.tscn` и сохраните новую сцену в папку своего оружия как `имя_оружия_в_snake_case.tscn`.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Унаследуйтесь от `game/weapons/throwable/common/throwable_ammo.tscn`, назовите корневой узел как `<имя вашего оружия в PascalCase>Ammo` и сохраните новую сцену боеприпаса в папку своего оружия как `имя_оружия_в_snake_case_ammo.tscn`.
4. Нарисуйте оружие (см. Общие моменты).
5. В сцене боеприпаса разместите бросаемый предмет. Учитывайте, что начало координат - центр вращения боеприпасов в "руке" игрока.
6. Там же в узле `AnimationPlayer` создайте нужные анимации.
    - `Reload`: анимация перезарядки.
    - `RESET`: анимация сброса. Должна содержать начальное положение оружия и скрывать любые эффекты. Она используется для сброса состояния оружия в любой момент, как игрок пожелает. Автоматически создаётся движком по мере создания дорожек анимации.
    - `Throw`: анимация, в которой оружие готовится к броску. Первой дорожкой должен быть `position` бросаемого объекта с двумя ключами. Второй ключ будет отредактирован в коде для перемещения оружия в нужную точку.
    - `PostThrow`: анимация непосредственно броска. Первой дорожкой должен быть `position` бросаемого объекта с двумя ключами (их значения не важны). Они будут отредактированы в коде для перемещения оружия в нужную точку. Второй дорожкой должен быть `rotation` - в ней второй ключ будет заменён на нужный.
7. Настройте оружие. Отредактируйте нужные свойства у коренного узла, в частности `Ammo Scene`. Изучите их всех (обратитесь к документации) и настройте как надо. `Projectile Scene` пока назначать не нужно - это мы сделаем позже.
8. Переместите `ThrowPivot` (точка отвода боеприпаса перед броском), `ThrowPoint` (точка, откуда вылетит боеприпас) и `Ammo` (где держатся все боеприпасы) в нужные положения.
9. После этого в узле `AnimationPlayer` создайте нужные анимации: `Equip` (анимация экипировки) и `RESET` (анимация сброса).
10. Создайте снаряд, унаследовавшись от `game/entity/attack/projectile.tscn`, отредактируйте урон и скорость и сохраните в папку Вашего оружия. Не забудьте указать эту сцену в `Spawnable Scenes Paths` и в `Projectile Scene`!
11. В соответствии с шириной области нанесения урона у снаряда отредактируйте `Width` у `Aim` (у `Outline` поставьте ширину на 4 пикселя больше). Если область атаки у снаряда - луч, поставьте ширину 8 пикселей. Не забудьте передвинуть `SpreadLeft` и `SpreadRight` так, чтобы они были у боков `Aim`.
12. При необходимости можно расширить скрипт оружия и написать собственную логику, будь то дополнительная кнопка или что-нибудь ещё.

### Граната (класс `Grenade`)

1. Унаследуйтесь от `game/weapons/grenades/common/grenade.tscn` и сохраните новую сцену в папку своего оружия как `имя_оружия_в_snake_case.tscn`.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Нарисуйте оружие (см. Общие моменты).
4. Расположите в сцене спрайты с текстурами оружия.
5. Переместите `ThrowPivot` (точка отвода гранаты перед броском) и `ThrowPoint` (точка, откуда вылетит граната) в нужные положения.
6. Там же в узле `AnimationPlayer` создайте нужные анимации.
    - `Equip`: анимация экипировки. В ней в самом начале включайте видимость спрайтов гранаты.
    - `RESET`: анимация сброса. Должна содержать начальное положение оружия и скрывать любые эффекты. Эта анимация используется для сброса состояния оружия в любой момент, как игрок пожелает (например, смена на другое оружие). Автоматически создаётся движком по мере создания дорожек в других анимациях. Здесь спрайты гранаты должны быть скрыты.
    - `Throw`: анимация броска, в которой граната готовится к броску. В конце отводите гранату до позиции `ThrowPivot`. Не изменяйте видимость спрайтов гранаты здесь.
    - `PostThrow`: анимация непосредственно броска. Первой дорожкой должен быть `position` спрайта гранаты с двумя ключами (их значения не важны). Они будут отредактированы в коде для перемещения спрайта в нужную точку. В конце этой анимации поворот гранаты должен стать равным нулю.
7. Настройте оружие. Отредактируйте нужные свойства у коренного узла. Изучите их всех (обратитесь к документации) и настройте как надо. `Projectile Scene` пока назначать не нужно - это мы сделаем позже. Также укажите время перезарядки гранаты в `ThrowTimer`.
8. Создайте снаряд гранаты, унаследовавшись от `game/weapons/grenades/common/grenade_projectile.tscn`.
    - Назовите корневой узел как `<имя вашего оружия в PascalCase>Projectile`, установите `Speed` и `Damping` в соответствии со значениями `Projectile Speed` и `Projectile Damping` на узле гранаты, а `Wait Time` на узле `ExplosionTimer` в соответствии с `Projectile Explosion Time`.
    - Поместите текстуру гранаты в узел `Grenade`.
    - Расширьте скрипт корневого узла сцены снаряда и переопределите в нём метод `_explode`. Напишите там всю логику взрыва, которая может включать взаимодействие с узлами.
    - Сохраните полученную сцену в папку Вашего оружия как `имя_вашего_оружия_projectile.tscn`. Не забудьте указать эту сцену в `Spawnable Scenes Paths` и в `Projectile Scene`!
11. В соответствии с размером гранаты отредактируйте `Width` у `Aim` (у `Outline` поставьте ширину на 4 пикселя больше).
12. При необходимости можно расширить скрипт оружия и написать собственную логику, будь то дополнительная кнопка или что-нибудь ещё. Например, можно переопределить `_customize_projectile` для изменения снаряда перед добавлением в дерево.

### Ближнее оружие (класс `Melee`)

1. Унаследуйтесь от `game/weapons/melee/common/melee.tscn` и сохраните новую сцену в папку своего оружия как `имя_оружия_в_snake_case.tscn`.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Нарисуйте оружие (см. Общие моменты).
4. Расположите в сцене спрайты с текстурами оружия. Не рекомендую менять `position`, вместо этого меняйте `offset` у `Sprite2D`. Позицию меняйте только в анимациях.
5. Настройте оружие: установите нужные свойства на корневом узле и `Attack`.
6. Добавьте один из трёх `Detector`-ов в качестве дочернего к `Attack`. Настройте ему форму, не забывайте про слои столкновения.
7. С помощью `Line2D` нарисуйте область атаки. Имя узла - `Aim`.
8. Создайте нужные анимации:
    - `Equip`: анимация экипировки. Не доводите оружие полностью до боевой готовности (см. ниже).
    - `PostEquip`: анимация окончания экипировки. Здесь нужно довести оружие до боевой готовности, то есть отсутствия отклонения от линии прицела. Её длительность **должна** совпадать со свойством `To Aim Time`.
    - `Attack`: анимация удара оружием. Длительность желательно должна совпадать с `Shoot Interval`, но это необязательно.
    - `RESET`: анимация сброса. Должна содержать начальное положение оружия и скрывать любые эффекты. Эта анимация используется для сброса состояния оружия в любой момент, как игрок пожелает (например, смена на другое оружие). Автоматически создаётся движком по мере создания дорожек в других анимациях.
9. При необходимости можно расширить скрипт оружия и написать собственную логику, будь то дополнительная кнопка или что-нибудь ещё.

## Создание класса оружия

1. Создайте папку `game/weapons/<имя нового класса>` (имя должно быть в *snake_case*), а в ней создайте папку `common`.
2. Создайте новый скрипт с именем `<имя нового класса>.gd` (в *snake_case*) в этой папке, унаследуйте этот скрипт от `Weapon` (рекомендуется использовать шаблон) и дайте скрипту `class_name` с названием Вашего класса (но уже в *PascalCase*).
3. Создайте сцену `<имя нового класса>.tscn` (в *snake_case*) в этой папке. Тип коренного узла должен быть создаваемым классом (и называться так же, в *PascalCase*).
4. Напишите логику этого класса.
    - Рекомендуется делать её более менее расширяемой, чтобы в дочерних классах не переписывать половину скрипта.
    - Экспортируйте свойства с различными настройками.
    - Задокументируйте публичные (в т.ч. экспортированные) свойства и методы, а также методы для переопределения с помощью docstring.
5. Если того требует код, создайте нужные узлы в сцене класса.
6. Если класс подразумевает какие-то ресурсы, общие для всех оружий данного класса, то храните их в папке `common`.
7. После того, как Вы создадите всю логику, напишите подраздел в этой документации с инструкцией по созданию оружия данного класса.

## Создание оружия без определённого класса

1. Создайте новую сцену с корневым узлом типа `Weapon` и сохраните её как `имя_оружия_в_snake_case.tscn` в папку оружия.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Нарисуйте оружие (см. Общие моменты).
4. Расположите в сцене спрайты с текстурами оружия. Не рекомендую менять `position`, вместо этого меняйте `offset` у `Sprite2D`. Позицию меняйте только в анимациях.
5. Унаследуйте скрипт на корневом узле. Переопределяя различные методы, напишите нужную логику. В отличии от создания оружий существующего класса, здесь Вас ничего не ограничивает.
