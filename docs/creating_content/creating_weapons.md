# Создание оружия

Процесс создания оружие сильно зависит от того, создаёте ли Вы оружие нового типа или уже существующего. Обратитесь к нужной секции документа, когда сделаете выбор. Не забудьте прочитать общие инструкцию и моменты.

## Общая инструкция

**Заметка**: это инструкция по созданию *оружия*. Если Вы хотите создать *класс оружия*, обратитесь к [соответствующей секции документа](#создание-класса-оружия).

1. Создайте папку в `game/weapons/<класс оружия>` с именем Вашего оружия в *snake_case*, где *класс оружия* - название класса создаваемого оружия (или `other`, если Вы не относите его ни к какому классу).
2. В этой папке создайте ресурс типа `WeaponData`, назовите именем Вашего оружия (всё ещё в *snake_case*) и заполните в нём информацию:
    - В `Name` введите название Вашего оружия.
    - В `Rarity` укажите редкость оружия. Как определяется редкость см. [`giving_rarity.md`](./giving_rarity.md#оружия).
    - В `ID` укажите идентификатор Вашего оружия (на английском). Он должен отражать сущность оружия, но подражать имени не обязан, так что можно вписать какую-нибудь связанную с создаваемым оружием шутку :)
    - Во вкладке `Stats`:
        - В `Damage Text` кратко укажите, какой урон наносит оружие.
            - Для большинства рекомендуется формат "Урон/с: ХХ", однако для оружия, делающего редкие выстрелы (между ними секунда и более), или одноразового оружия (гранаты) можно просто указать "Урон: ХХ".
            - Если же оружие не наносит урон, кратко опишите его действие.
        - В `Ammo Text` укажите количество боеприпасов оружия в формате "<боеприпасов в магазине>/<боеприпасов в запасе>".
            - Если оружие не имеет магазина, то напишите "ХХ штук(и)".
            - Если же количество боеприпасов неограниченно, то так и напишите: "Не ограничено".
        - В `Description` полностью опишите оружие по плану ниже, отделяя пункты друг от друга пустой строкой. Рекомендуется выделять числа с помощью *BBCode*: связанное с уроном - красным, с боеприпасами - синим, особенности - голубым. Максимальная точность дробных чисел - десятые доли.
            - Урон и особенности
            - Боеприпасы и перезарядка
            - Текстовое описание
    - `Scene Path` и `Image Path` будут заполнены позже.
3. Создайте сцену оружия и само оружие. Обратитесь к секциям ниже для большей информации.
4. Полученную сцену с оружием сохраните в папку Вашего оружия с именем в *snake_case*. Укажите её в `*.tres`-файле Вашего оружия (свойство `Scene Path`).
    - Если оружие создаёт объекты, которые должны быть появляться у всех (например, пули), то укажите их сцены в `Spawnable Scenes Paths` в `*.tres`-файле Вашего оружия.
5. Для оружия необходима его обложка разрешением 256 пикселей по *большей* стороне. Скорей всего, изображение целого оружия у вас осталось с момента рисования. Измените его размер до нужного и сохраните его как `image.png` в папку Вашего оружия.
6. Укажите полученный `image.png` в свойстве `Image Path` `*.tres`-файла Вашего оружия.
7. Откройте `game/core/items_db.tres` и добавьте `*.tres`-файл Вашего оружия в свойство `Weapons <тип оружия>`, где *тип оружия* - *Light* (лёгкое), *Heavy* (тяжёлое), *Support* (поддержка) или *Melee* (ближнее).
8. Готово! Теперь Ваше оружие можно выбрать в игре.
9. Протестируйте его и при необходимости сбалансируйте. Не забудьте отредактировать `Damage Text`, `Ammo Text` и `Description`.

## Общие моменты

- Создавайте объекты в качестве дочерних к узлу `ProjectilesParent` (можно использовать свойство `_projectiles_parent` в скрипте оружия) если нужно, чтобы их появление синхронизировалось между клиентами.
- Главное правило при создании оружия конкретного класса - если непонятно, взгляните на другие оружия этого класса!
- Оптимизируйте рендеринг оружия при помощи `Region` у `Sprite2D` в случае, если в текстуре много прозрачных областей (магазин, затвор, ...). Используйте при этом сетку и шаг в 8 пикселей. Чтобы поставить спрайт в нужную позицию, поменяйте `Offset` по следующей формуле для каждой оси: `(размертекстуры по X|Y) / -2 + (регион X|Y) + (регион W|H) / 2 + (изначальный offset)`.
- Начало координат в сцене оружия - точка, в которой игрок держится за оружие, она же и ось вращения.
- Если оружие не имеет магазина, то в `Ammo Per Load` напишите 0 и используйте только `ammo_in_stock`.
- Помните, что изначальное количество боеприпасов в запасе это `Ammo Total - Ammo Per Load`. Учитывайте это в `Ammo Text`.
- Перед рисованием ознакомьтесь с [`drawing.md`](./drawing.md), а также про ещё несколько моментов:
    - Рекомендуется рисовать оружия по слоям. Это позволяет проще вносить изменения в будущем и сохранять части оружия (затвор, магазин).
    - Насчёт разрешения текстур: если внутри игры оружие должно быть меньше 256 пикселей по большей стороне, то рисуйте текстуру в разрешении 256 по большей стороне, а при экспорте просто уменьшите **на время** размер.
    - После того как закончите рисовать, сохраните файл в формате в куда нибудь в папку `krita`, чтобы не потерять оригинал.
    - И после этого уменьшайте/увеличивайте размеры, скрывайте/показывайте слои как надо, чтобы сохранить нужные текстуры в папку оружия (не забудьте `image.png`!).
- Не забывайте устанавливать `collision_layer` и `collision_mask` у детекторов для атаки (см. [`architecture.md`](../architecture.md#физика) для информации по слоям).

## Создание оружия существующего класса

### Пистолет (класс `Gun`)

1. Унаследуйтесь от `game/weapons/guns/common/gun.tscn` и сохраните новую сцену в папку своего оружия как `имя_оружия_в_snake_case.tscn`.
2. Переименуйте корневой узел на имя Вашего оружия, но уже в *PascalCase*.
3. Нарисуйте оружие (см. Общие моменты).
4. Расположите в сцене спрайты с текстурами оружия. Не рекомендую менять `position`, вместо этого меняйте `offset` у `Sprite2D`. Позицию меняйте только в анимациях.
5. Настройте оружие. Посмотрите, сколько разных свойств у коренного узла! Изучите их всех (обратитесь к документации) и настройте как надо. `Projectile Scene` пока назначать не нужно - это мы сделаем позже.
6. После этого в узле `AnimationPlayer` создайте нужные анимации.
    - `Equip`: анимация экипировки. Не доводите оружие полностью до боевой готовности (см. ниже).
    - `PostEquip`: анимация окончания экипировки. Здесь нужно довести оружие до боевой готовности, то есть отсутствия отклонения от линии прицела. Её длительность **должна** совпадать со свойством `To Aim Time`.
    - `Reload`: анимация перезарядки. Не доводите оружие полностью до боевой готовности (аналогично `Equip`).
    - `PostReload`: анимация окончания перезарядки. Здесь нужно довести оружие до боевой готовности. Её длительность тоже **должна** совпадать со свойством `To Aim Time`.
    - `Shoot`: анимация стрельбы. Длительность желательно должна совпадать с `Shoot Interval`, но это необязательно.
    - `RESET`: анимация сброса. Должна содержать начальное положение оружие и скрывать любые эффекты. Она используется для сброса состояния оружия в любой момент, как игрок пожелает. Автоматически создаётся движком по мере создания дорожек анимации.
7. Переместите `ShootPoint` в точку, откуда должны вылетать снаряды.
8. Создайте снаряд, унаследовавшись от `game/weapon/guns/common/bullet.tscn` (или напрямую от `game/entity/attack/projectile.tscn`), отредактируйте урон и скорость и сохраните в папку Вашего оружия. Не забудьте указать эту сцену в `Spawnable Scenes Paths` и в `Projectile Scene`!
9. При необходимости можно расширить скрипт оружия и написать собственную логику, будь то дополнительная кнопка или что-нибудь ещё.

### Граната (класс `Grenade`)

TODO

### Ближнее оружие (класс `Melee`)

TODO

## Создание класса оружия

1. Создайте папку `game/weapons/<имя нового класса>` (имя должно быть в *snake_case*), а в ней создайте папку `common`.
2. Создайте новый скрипт с именем `<имя нового класса>.gd` (в *snake_case*) в этой папке, унаследуйте этот скрипт от `Weapon` (рекомендуется использовать шаблон) и дайте скрипту `class_name` с названием Вашего класса (но уже в *PascalCase*).
3. Напишите логику этого класса.
    - Рекомендуется делать её более менее расширяемой, чтобы в дочерних классах не переписывать половину скрипта.
    - Экспортируйте свойства с различными настройками.
    - Задокументируйте публичные (в т.ч. экспортированные) свойства и методы, а также методы для переопределения с помощью docstring.
4. Если класс подразумевает какие-то ресурсы, общие для всех оружий данного класса, то храните их в папке `common`.
5. После того, как Вы создадите всю логику, напишите подраздел в этой документации с инструкцией по созданию оружия данного класса.

## Создание оружия без определённого класса

TODO
